name: Build Hagicode Desktop

on:
  push:
    branches:
      - main
    tags:
      - "v*.*.*"
  workflow_dispatch:

permissions:
  contents: write

env:
  NODE_VERSION: "22"

jobs:
  ################################################################################
  # Windows Build Job
  ################################################################################
  build-windows:
    name: Build for Windows
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: package-lock.json

      - name: Sync version from tag
        if: startsWith(github.ref, 'refs/tags/v')
        shell: bash
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          echo "Syncing npm/package.json version to ${VERSION}"
          npm version "${VERSION}" --no-git-tag-version

      - name: Install dependencies
        run: npm ci

      - name: Build for Windows
        run: node scripts/ci-build.js --platform win
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Upload each artifact separately
      - name: Upload NSIS installer
        uses: actions/upload-artifact@v4
        if: success() && !startsWith(github.ref, 'refs/tags/v')
        with:
          name: hagicode-windows-nsis-${{ github.sha }}
          path: pkg/*Setup*.exe
          retention-days: 30
          if-no-files-found: warn

      - name: Upload NSIS installer to Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/v')
        with:
          files: pkg/*Setup*.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload AppX package
        uses: actions/upload-artifact@v4
        if: success() && !startsWith(github.ref, 'refs/tags/v')
        with:
          name: hagicode-windows-appx-${{ github.sha }}
          path: pkg/*.appx
          retention-days: 30
          if-no-files-found: warn

      - name: Upload AppX package to Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/v')
        with:
          files: pkg/*.appx
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload portable
        uses: actions/upload-artifact@v4
        if: success() && !startsWith(github.ref, 'refs/tags/v')
        with:
          name: hagicode-windows-portable-${{ github.sha }}
          path: pkg/Hagicode*.exe
          retention-days: 30
          if-no-files-found: warn

      - name: Upload portable to Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/v')
        with:
          files: pkg/Hagicode*.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  ################################################################################
  # Linux Build Job
  ################################################################################
  build-linux:
    name: Build for Linux
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: package-lock.json

      - name: Sync version from tag
        if: startsWith(github.ref, 'refs/tags/v')
        shell: bash
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          echo "Syncing npm/package.json version to ${VERSION}"
          npm version "${VERSION}" --no-git-tag-version

      - name: Install dependencies
        run: npm ci

      - name: Build for Linux
        run: node scripts/ci-build.js --platform linux
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Upload each artifact separately
      - name: Upload AppImage
        uses: actions/upload-artifact@v4
        if: success() && !startsWith(github.ref, 'refs/tags/v')
        with:
          name: hagicode-linux-appimage-${{ github.sha }}
          path: pkg/*.AppImage
          retention-days: 30
          if-no-files-found: warn

      - name: Upload AppImage to Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/v')
        with:
          files: pkg/*.AppImage
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload deb
        uses: actions/upload-artifact@v4
        if: success() && !startsWith(github.ref, 'refs/tags/v')
        with:
          name: hagicode-linux-deb-${{ github.sha }}
          path: pkg/*.deb
          retention-days: 30
          if-no-files-found: warn

      - name: Upload deb to Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/v')
        with:
          files: pkg/*.deb
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload tar.gz
        uses: actions/upload-artifact@v4
        if: success() && !startsWith(github.ref, 'refs/tags/v')
        with:
          name: hagicode-linux-targz-${{ github.sha }}
          path: pkg/*.tar.gz
          retention-days: 30
          if-no-files-found: warn

      - name: Upload tar.gz to Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/v')
        with:
          files: pkg/*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  ################################################################################
  # macOS Build Job
  ################################################################################
  build-macos:
    name: Build for macOS
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: package-lock.json

      - name: Sync version from tag
        if: startsWith(github.ref, 'refs/tags/v')
        shell: bash
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          echo "Syncing npm/package.json version to ${VERSION}"
          npm version "${VERSION}" --no-git-tag-version

      - name: Install dependencies
        run: npm ci

      - name: Build for macOS
        run: node scripts/ci-build.js --platform mac
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Upload each artifact separately
      - name: Upload DMG
        uses: actions/upload-artifact@v4
        if: success() && !startsWith(github.ref, 'refs/tags/v')
        with:
          name: hagicode-macos-dmg-${{ github.sha }}
          path: pkg/*.dmg
          retention-days: 30
          if-no-files-found: warn

      - name: Upload DMG to Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/v')
        with:
          files: pkg/*.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload ZIP
        uses: actions/upload-artifact@v4
        if: success() && !startsWith(github.ref, 'refs/tags/v')
        with:
          name: hagicode-macos-zip-${{ github.sha }}
          path: pkg/*.zip
          retention-days: 30
          if-no-files-found: warn

      - name: Upload ZIP to Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/v')
        with:
          files: pkg/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  ################################################################################
  # Build Summary Job
  ################################################################################
  build-summary:
    name: Build Summary
    needs:
      - build-windows
      - build-linux
      - build-macos
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Check build status
        run: |
          echo "Windows Build: ${{ needs.build-windows.result }}"
          echo "Linux Build: ${{ needs.build-linux.result }}"
          echo "macOS Build: ${{ needs.build-macos.result }}"

      - name: Build failed notification
        if: needs.build-windows.result == 'failure' || needs.build-linux.result == 'failure' || needs.build-macos.result == 'failure'
        run: |
          echo "::error::One or more builds failed. Please check the logs."
          exit 1

      - name: Determine workflow status
        id: status
        if: always()
        run: |
          # Check all dependent jobs
          windows_status="${{ needs.build-windows.result }}"
          linux_status="${{ needs.build-linux.result }}"
          macos_status="${{ needs.build-macos.result }}"

          echo "Windows: ${windows_status}"
          echo "Linux: ${linux_status}"
          echo "macOS: ${macos_status}"

          # Determine overall status
          if [ "${windows_status}" == "failure" ] || [ "${linux_status}" == "failure" ] || [ "${macos_status}" == "failure" ]; then
            echo "overall=failed" >> $GITHUB_OUTPUT
            echo "status_icon=❌" >> $GITHUB_OUTPUT
            echo "status_text=失败" >> $GITHUB_OUTPUT
          else
            echo "overall=success" >> $GITHUB_OUTPUT
            echo "status_icon=✅" >> $GITHUB_OUTPUT
            echo "status_text=成功" >> $GITHUB_OUTPUT
          fi

      - name: Build platforms summary
        id: platforms
        if: always()
        run: |
          windows_status="${{ needs.build-windows.result }}"
          linux_status="${{ needs.build-linux.result }}"
          macos_status="${{ needs.build-macos.result }}"

          platforms=()
          [ "${windows_status}" == "success" ] && platforms+=("Windows")
          [ "${linux_status}" == "success" ] && platforms+=("Linux")
          [ "${macos_status}" == "success" ] && platforms+=("macOS")

          if [ ${#platforms[@]} -eq 0 ]; then
            platforms_str="无"
          else
            platforms_str=$(IFS=", "; echo "${platforms[*]}")
          fi

          echo "platforms=${platforms_str}" >> $GITHUB_OUTPUT

      - name: Notify Feishu
        if: always()
        uses: HagiCode-org/haginotifier@v1.0.0
        with:
          message: |
            **Flow 执行完成**

            状态: ${{ steps.status.outputs.status_icon }} ${{ steps.status.outputs.status_text }}
            分支: ${{ github.ref_name }}
            提交: `${{ github.sha }}`
            触发者: ${{ github.actor }}
            事件: ${{ github.event_name }}
            构建平台: ${{ steps.platforms.outputs.platforms }}

            [查看详情](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          msg_type: 'post'
          title: 'Hagicode Desktop 构建通知 ${{ steps.status.outputs.status_icon }}'
        env:
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}

  ################################################################################
  # Sync to Azure Storage Job
  ################################################################################
  sync-azure:
    name: Sync to Azure Storage
    needs: build-summary
    if: startsWith(github.ref, 'refs/tags/v')
    uses: ./.github/workflows/sync-azure-storage.yml
    with:
      release_tag: ${{ github.ref_name }}
    secrets: inherit
