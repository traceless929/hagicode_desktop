name: Sync Release to Azure Storage

# This workflow is called by build.yml after a release is created.
on:
  workflow_call:
    inputs:
      release_tag:
        description: 'Release tag to sync'
        required: true
        type: string
      release_channel:
        description: 'Release channel (stable, beta, dev)'
        required: false
        type: string
        default: 'beta'
    secrets:
      FEISHU_WEBHOOK_URL:
        required: true
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag to sync (empty for latest release)'
        required: false
        type: string
      release_channel:
        description: 'Release channel (stable, beta, dev)'
        required: false
        type: choice
        options:
        - stable
        - beta
        - dev

# GITHUB_TOKEN Permissions
# - contents: read - Required for accessing Release assets via gh CLI
# Reference: hagicode-release project for implementation pattern
permissions:
  contents: read

jobs:
  sync:
    name: Sync Release Assets to Azure Storage
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET SDK
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'

    - name: Determine release tag
      id: release_info
      run: |
        # From workflow_call input, or fetch latest for manual dispatch
        if [ -n "${{ inputs.release_tag }}" ]; then
          RELEASE_TAG="${{ inputs.release_tag }}"
        else
          RELEASE_TAG=$(gh release view --json tagName -q .tagName)
          echo "No tag specified, using latest release: ${RELEASE_TAG}"
        fi
        echo "tag=${RELEASE_TAG}" >> $GITHUB_OUTPUT
        echo "Release tag: ${RELEASE_TAG}"
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Run Nuke Sync to Azure
      run: ./build.sh --target Default
      # GitHub Token Configuration:
      # - GITHUB_TOKEN: Used by Nuke GitHubActions integration (EnableGitHubToken=true)
      # - GH_TOKEN: Used by gh CLI commands for GitHub API access
      # Both tokens sourced from secrets.GITHUB_TOKEN
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        AZURE_BLOB_SAS_URL: ${{ secrets.AZURE_BLOB_SAS_URL }}
        RELEASE_TAG: ${{ steps.release_info.outputs.tag }}
        RELEASE_CHANNEL: ${{ inputs.release_channel }}
        FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
        GITHUB_RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        GITHUB_SHA: ${{ github.sha }}
        GITHUB_ACTOR: ${{ github.actor }}

    - name: Report failure
      if: failure()
      run: |
        echo "::error::Failed to sync release assets to Azure Storage"
        echo "Please check:"
        echo "  1. AZURE_BLOB_SAS_URL secret is correctly configured"
        echo "  2. SAS token has 'Write' permissions"
        echo "  3. SAS token has not expired"
        echo "  4. Container exists in Azure Storage"
        exit 1
