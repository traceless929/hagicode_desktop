# 提案：智能 npm 镜像自动配置

## 概述

为 Hagicode Desktop 添加基于地理位置的 npm 镜像自动配置功能。当检测到用户位于中国大陆时，在安装 Claude Code、OpenSpec 等 NPM 工具集时自动使用淘宝镜像源，显著提升依赖安装速度和开发体验。

## 背景

Hagicode Desktop 在开发和运行过程中需要安装特定的 NPM 工具集（如 Claude Code、OpenSpec），当前存在以下挑战：

1. **网络环境差异**：中国大陆用户访问默认 npm 源时速度缓慢或连接失败
2. **缺乏智能镜像选择**：无自动检测地理位置并配置镜像的机制
3. **Hard Code 依赖**：Claude Code、OpenSpec 等工具集作为 Hard Code 依赖项，需要通过 npm 安装
4. **用户无需手动操作**：现阶段应根据用户地理位置自动配置，无需用户手动选择源

**说明**：本项目需要安装的 NPM 工具集包括：
- Claude Code：AI 辅助开发工具
- OpenSpec：项目使用的规范驱动开发框架

## 提案变更

### 1. 地理位置自动检测（简化版）

实现轻量级用户位置检测机制：

- 基于系统语言设置判断用户是否在中国大陆（`app.getLocale()` 检测 `zh-CN`）
- IP 地址检测作为可选的增强方案（可后续添加）
- 在首次启动或首次需要安装 NPM 工具时检测
- 检测结果缓存，避免重复检测

### 2. 智能 npm 镜像自动配置

针对中国大陆用户优化 NPM 工具安装体验：

- **自动配置淘宝 npm 镜像**（`https://registry.npmmirror.com`）
- **仅在安装 NPM 工具集时生效**（Claude Code、OpenSpec 等）
- **临时配置**：通过环境变量或命令行参数指定镜像，不修改全局 `.npmrc`
- **检测到中国大陆环境时自动应用**，无需用户确认
- **国际用户不受影响**，继续使用官方 npm 源

### 3. 简化的用户反馈（可选）

仅在设置页面提供基本信息显示：

- 当前检测到的地区
- 当前使用的镜像源（官方/淘宝）
- 提供"重新检测"和"强制使用官方源"选项（高级功能）

## 影响分析

### 用户体验改进

- **中国大陆用户**：显著提升 Claude Code、OpenSpec 等 NPM 工具的安装速度（从可能失败到快速完成）
- **国际用户**：完全无影响，继续使用官方 npm 源
- **零配置体验**：用户无需手动操作，系统自动根据地理位置配置最优镜像

### 技术实现

**新增模块**：
- `src/main/npm-mirror-helper.ts` - npm 镜像辅助工具（轻量级）
  - `detectRegion()` - 基于系统语言检测地区
  - `getNpmInstallArgs()` - 返回安装命令所需的镜像参数
  - `cacheDetectionResult()` - 缓存检测结果

**扩展现有功能**：
- 修改现有 NPM 工具安装逻辑，集成镜像辅助工具
- 在安装 Claude Code、OpenSpec 等工具时使用检测到的镜像配置

**可选 UI 组件**（低优先级）：
- `src/renderer/components/settings/MirrorStatusCard.tsx` - 简单的状态显示卡片
- 仅显示当前地区和使用的镜像源，不提供复杂配置界面

**配置存储**：
- 使用 electron-store 存储检测结果
- 配置键名：`npmRegionDetection`（存储地区和检测时间）

### 兼容性

- **向后兼容**：不影响现有依赖安装流程
- **完全自动化**：无需用户配置，开箱即用
- **跨平台支持**：支持 Windows、macOS、Linux

### 安全性

- 镜像配置仅影响 NPM 工具安装时的 npm 命令
- 使用可信任的淘宝 npm 镜像（官方维护）
- 不修改全局 `.npmrc`，影响范围受控
- 用户可查看但无需手动配置

## 替代方案

### 方案 A：修改全局 .npmrc（被否决）

**优点**：配置全局生效，一次配置永久使用

**缺点**：
- 影响用户所有 npm 项目，超出本需求范围
- 用户可能不希望全局使用镜像
- 修改用户配置文件需要谨慎处理权限问题

### 方案 B：复杂的多源依赖管理（被否决）

**优点**：功能全面，支持多种依赖源

**缺点**：
- 过度设计，超出实际需求
- 增加不必要的复杂度和维护成本
- 用户无需手动管理多个源

### 方案 C：自动检测 + 临时镜像配置（推荐）

**优点**：
- 最简实现，满足核心需求
- 零用户配置，开箱即用
- 影响范围受控（仅限 NPM 工具安装）
- 易于维护和扩展

**缺点**：
- 仅支持淘宝镜像（后续可扩展）

## 风险与缓解

### 风险 1：系统语言检测不准确

**影响**：部分中文用户可能使用英文系统语言

**缓解措施**：
- 缓存检测结果，用户可手动调整（高级功能）
- 提供强制使用官方源选项
- 后续可添加 IP 检测作为增强

### 风险 2：淘宝镜像临时不可用

**影响**：NPM 工具安装失败

**缓解措施**：
- 不修改全局配置，容易回退
- 提供手动重试和切换选项
- 记录详细日志便于排查

### 风险 3：环境变量在某些环境下不生效

**影响**：镜像配置未生效

**缓解措施**：
- 测试多种安装方式（npm install with --registry）
- 提供配置验证机制
- 记录安装日志确认镜像使用情况

## 实施计划

详细的实施任务列表请参见 [tasks.md](./tasks.md)。

主要里程碑：

1. **阶段 1**：核心模块实现（轻量级地区检测）
2. **阶段 2**：NPM 工具安装集成
3. **阶段 3**：可选的 UI 状态显示（低优先级）
4. **阶段 4**：测试与优化

## 成功标准

### 功能完整性

- ✅ 应用首次启动时自动检测用户地区（基于系统语言）
- ✅ 检测到中国大陆时，安装 Claude Code、OpenSpec 等工具自动使用淘宝镜像
- ✅ 国际用户继续使用官方 npm 源，完全无影响
- ✅ 检测结果被缓存，避免重复检测
- ✅ （可选）用户可在设置页面查看当前地区和镜像源状态

### 性能指标

- ✅ 地区检测在 1 秒内完成（仅检查系统语言）
- ✅ 检测过程完全不阻塞应用启动
- ✅ 中国大陆用户使用镜像源时安装速度显著提升

### 用户体验

- ✅ 零配置体验，用户无需任何手动操作
- ✅ 安装过程对用户透明
- ✅ 如提供 UI，状态显示简洁清晰
- ✅ 支持中英文界面（如提供 UI）

## 规范变更

本提案将创建以下规范增量：

- **npm-mirror-config**：npm 镜像自动配置相关规范
  - 新增需求：地区自动检测（基于系统语言）
  - 新增需求：淘宝镜像自动应用
  - 新增需求：检测结果缓存
  - （可选）新增需求：镜像状态显示

详细规范内容参见 [specs/npm-mirror-config/spec.md](./specs/npm-mirror-config/spec.md)。

## 参考资料

- [淘宝 npm 镜像文档](https://npmmirror.com/)
- [electron-store 文档](https://github.com/sindresorhus/electron-store)
- 现有依赖管理实现：`src/main/dependency-manager.ts`
- 现有包管理实现：`src/main/package-manager.ts`
