# Tasks: 基于 DML 架构建立 Hagicode 桌面应用

**Change ID:** `electron-desktop-app-dml-architecture`
**Status:** Pending
**Created:** 2025-02-02

---

## 任务概览 (Overview)

本任务清单将工作分解为可执行的小步骤，每个任务都应该是可验证的、能带来可见进展的工作项。

### 执行策略

1. **先基础后功能** - 先完成架构和开发环境，再实现具体功能
2. **并行优先** - 可并行的任务尽可能同时进行
3. **持续验证** - 每个阶段完成后进行验证测试
4. **增量交付** - 每完成一个模块即可运行和演示

---

## Phase 1: 项目初始化和架构迁移

### 1.1 基础项目结构
- [ ] **Task 1.1.1**: 创建 `client/` 目录作为 Electron 主目录
  - 验证: `client/` 目录存在且为空
  - 依赖: 无
  - 预计时间: 5 分钟

- [ ] **Task 1.1.2**: 从 DML 迁移目录结构到 `client/`
  - 创建 `src/main/`, `src/renderer/`, `src/preload/`, `resources/`, `scripts/`
  - 验证: 目录结构与 DML 一致
  - 依赖: Task 1.1.1
  - 预计时间: 10 分钟

### 1.2 配置文件迁移
- [ ] **Task 1.2.1**: 迁移并定制 `package.json`
  - 复制 DML 的 `package.json` 模板
  - 修改项目名称为 `hagico-desktop`
  - 修改产品名称为 `Hagicode Desktop`
  - 移除不需要的依赖（如 Steam 相关）
  - 验证: `npm install` 成功执行
  - 依赖: Task 1.1.2
  - 预计时间: 20 分钟

- [ ] **Task 1.2.2**: 迁移 TypeScript 配置
  - 复制 `tsconfig.json`, `tsconfig.node.json`
  - 验证: `tsc --noEmit` 无错误
  - 依赖: Task 1.2.1
  - 预计时间: 5 分钟

- [ ] **Task 1.2.3**: 迁移 Vite 配置
  - 复制 `vite.config.mjs` 并调整路径
  - 验证: `vite build` 能执行（无源码时可能失败但配置加载正常）
  - 依赖: Task 1.2.1
  - 预计时间: 10 分钟

- [ ] **Task 1.2.4**: 迁移 electron-builder 配置
  - 复制 `electron-builder.yml`
  - 更新应用名称、图标路径
  - 验证: 配置文件 YAML 格式正确
  - 依赖: Task 1.1.2
  - 预计时间: 15 分钟

### 1.3 开发脚本迁移
- [ ] **Task 1.3.1**: 迁移构建脚本
  - 复制 `scripts/` 目录中的核心脚本
  - 移除项目特定的逻辑（如版本管理脚本需要定制）
  - 验证: 脚本文件存在且可执行
  - 依赖: Task 1.1.2
  - 预计时间: 30 分钟

- [ ] **Task 1.3.2**: 验证开发命令
  - 测试 `npm run build:tsc:check`
  - 测试 `npm run dev:renderer`
  - 验证: 命令能正常执行（即使源码为空）
  - 依赖: Task 1.2.2, Task 1.2.3
  - 预计时间: 10 分钟

---

## Phase 2: Electron 主进程和渲染进程

### 2.1 主进程基础架构
- [ ] **Task 2.1.1**: 创建主进程入口文件
  - 从 DML 迁移 `src/main/index.ts`
  - 移除 SuperDucky 特定逻辑
  - 配置基本窗口设置（标题、尺寸、图标）
  - 验证: 文件编译无 TypeScript 错误
  - 依赖: Task 1.3.2
  - 预计时间: 30 分钟

- [ ] **Task 2.1.2**: 实现基础窗口管理
  - 窗口创建和生命周期管理
  - 窗口关闭到托盘（不退出应用）
  - 验证: 主窗口能正常创建和关闭
  - 依赖: Task 2.1.1
  - 预计时间: 45 分钟

### 2.2 系统托盘实现
- [ ] **Task 2.2.1**: 创建系统托盘模块
  - 创建 `src/main/tray.ts`
  - 实现托盘图标加载
  - 实现右键菜单（显示窗口、退出）
  - 验证: 托盘图标在任务栏显示
  - 依赖: Task 2.1.2
  - 预计时间: 1 小时

- [ ] **Task 2.2.2**: 集成服务器状态到托盘
  - 托盘工具提示显示服务器状态
  - 托盘图标根据状态变化（运行中/已停止）
  - 验证: 状态变化反映到托盘
  - 依赖: Task 2.2.1, Task 3.1.1
  - 预计时间: 45 分钟

- [ ] **Task 2.2.3**: 实现托盘通知
  - Windows 原生通知
  - 服务器启动/停止通知
  - 错误提醒
  - 验证: 通知在 Windows 上正常显示
  - 依赖: Task 2.2.2
  - 预计时间: 30 分钟

### 2.3 预加载脚本
- [ ] **Task 2.3.1**: 创建预加载脚本
  - 从 DML 迁移 `src/preload/index.ts`
  - 暴露基本的 IPC 通信接口
  - 验证: 预加载脚本编译无错误
  - 依赖: Task 2.1.1
  - 预计时间: 20 分钟

### 2.4 渲染进程基础
- [ ] **Task 2.4.1**: 创建基础 React 应用
  - 创建 `src/renderer/App.tsx`
  - 设置基础布局和样式
  - 验证: `npm run dev:renderer` 能启动开发服务器
  - 依赖: Task 2.3.1
  - 预计时间: 30 分钟

- [ ] **Task 2.4.2**: 实现主窗口 UI 框架
  - 标题栏和内容区域
  - 响应式布局
  - 深色主题支持
  - 验证: 窗口能正常显示内容
  - 依赖: Task 2.4.1
  - 预计时间: 1 小时

---

## Phase 3: Hagicode Server 集成

### 3.1 服务器通信层
- [ ] **Task 3.1.1**: 创建服务器通信模块
  - 创建 `src/main/server.ts`
  - 实现 HTTP 请求封装（axios）
  - 实现状态查询 API
  - 验证: 单元测试通过（mock API）
  - 依赖: Task 2.1.1
  - 预计时间: 1.5 小时

- [ ] **Task 3.1.2**: 实现服务器控制 API
  - 启动服务器
  - 停止服务器
  - 重启服务器
  - 验证: 功能测试通过（连接真实服务器）
  - 依赖: Task 3.1.1
  - 预计时间: 1 小时

- [ ] **Task 3.1.3**: 实现状态轮询机制
  - 定时查询服务器状态
  - 状态变化时通知渲染进程
  - 验证: 状态更新延迟 < 3 秒
  - 依赖: Task 3.1.2
  - 预计时间: 45 分钟

### 3.2 配置管理
- [ ] **Task 3.2.1**: 实现配置存储
  - 使用 electron-store 存储配置
  - 服务器地址、端口配置
  - 验证: 配置能保存和读取
  - 依赖: Task 2.1.1
  - 预计时间: 30 分钟

- [ ] **Task 3.2.2**: 创建配置界面
  - 服务器地址输入
  - 连接测试按钮
  - 验证: UI 能保存配置
  - 依赖: Task 2.4.2, Task 3.2.1
  - 预计时间: 1 小时

### 3.3 主窗口功能
- [ ] **Task 3.3.1**: 实现服务器状态显示
  - 实时状态指示器
  - 运行时间统计
  - 版本信息显示
  - 验证: 状态信息准确显示
  - 依赖: Task 2.4.2, Task 3.1.3
  - 预计时间: 1 小时

- [ ] **Task 3.3.2**: 实现控制按钮
  - 启动/停止/重启按钮
  - 确认对话框
  - 验证: 按钮功能正常
  - 依赖: Task 3.1.2, Task 3.3.1
  - 预计时间: 45 分钟

---

## Phase 4: 资源和打包

### 4.1 应用图标和资源
- [ ] **Task 4.1.1**: 准备应用图标
  - 设计主图标（512x512 PNG）
  - 生成 Windows ICO
  - 生成 macOS ICNS
  - 生成 Linux PNG 图标集
  - 验证: 图标在各平台显示正常
  - 依赖: 无
  - 预计时间: 2 小时

- [ ] **Task 4.1.2**: 准备系统托盘图标
  - 设计普通状态托盘图标
  - 设计激活状态托盘图标
  - 支持 Windows 高 DPI
  - 验证: 托盘图标清晰无锯齿
  - 依赖: Task 4.1.1
  - 预计时间: 1 小时

### 4.2 本地构建验证
- [ ] **Task 4.2.1**: 验证 Windows 本地构建
  - 运行 `npm run build:win`
  - 测试 NSIS 安装包
  - 测试 Portable 版本
  - 验证: 安装包能正常安装和运行
  - 依赖: Task 3.3.2, Task 4.1.1
  - 预计时间: 1 小时

- [ ] **Task 4.2.2**: 验证 macOS 本地构建（如有 Mac 设备）
  - 运行 `npm run build:mac`
  - 测试 DMG 安装
  - 验证: 应用能在 macOS 启动
  - 依赖: Task 3.3.2, Task 4.1.1
  - 预计时间: 1 小时

- [ ] **Task 4.2.3**: 验证 Linux 本地构建
  - 运行 `npm run build:linux`
  - 测试 AppImage
  - 验证: AppImage 能正常运行
  - 依赖: Task 3.3.2, Task 4.1.1
  - 预计时间: 1 小时

---

## Phase 5: CI/CD 工作流

### 5.1 GitHub Actions 配置
- [ ] **Task 5.1.1**: 创建构建工作流
  - 复制 DML 的 `.github/workflows/build.yml`
  - 更新项目路径和名称
  - 验证: 工作流文件语法正确
  - 依赖: Task 4.2.1
  - 预计时间: 30 分钟

- [ ] **Task 5.1.2**: 配置平台特定工作流
  - 迁移 `build-windows.yml`
  - 迁移 `build-linux.yml`
  - 迁移 `build-macos.yml`
  - 验证: 工作流文件都存在且配置正确
  - 依赖: Task 5.1.1
  - 预计时间: 30 分钟

- [ ] **Task 5.1.3**: 配置 GitHub Secrets
  - 设置 GH_PAT 用于发布
  - 配置其他必要密钥
  - 验证: Secrets 配置完成
  - 依赖: Task 5.1.2
  - 预计时间: 15 分钟

### 5.2 自动更新配置
- [ ] **Task 5.2.1**: 配置 electron-updater
  - 在主进程集成更新检查
  - 配置更新源（GitHub Releases）
  - 验证: 更新检查逻辑正常
  - 依赖: Task 2.1.1
  - 预计时间: 45 分钟

- [ ] **Task 5.2.2**: 实现更新 UI
  - 更新可用通知
  - 下载进度显示
  - 安装和重启流程
  - 验证: 更新流程完整可用
  - 依赖: Task 2.4.2, Task 5.2.1
  - 预计时间: 1 小时

---

## Phase 6: 测试和发布

### 6.1 功能测试
- [ ] **Task 6.1.1**: Windows 平台测试
  - 安装测试
  - 系统托盘测试
  - 服务器控制测试
  - 自动更新测试
  - 验证: 所有核心功能正常，无崩溃
  - 依赖: Task 5.2.2
  - 预计时间: 2 小时

- [ ] **Task 6.1.2**: macOS 平台测试（如有 Mac 设备）
  - 同 Windows 测试项
  - 验证: 功能一致，符合 macOS 规范
  - 依赖: Task 5.2.2
  - 预计时间: 2 小时

- [ ] **Task 6.1.3**: Linux 平台测试
  - 同 Windows 测试项
  - 验证: 功能一致，符合 Linux 规范
  - 依赖: Task 5.2.2
  - 预计时间: 2 小时

### 6.2 性能优化
- [ ] **Task 6.2.1**: 启动时间优化
  - 延迟加载非关键模块
  - 优化主进程初始化
  - 验证: 启动时间 < 3 秒
  - 依赖: Task 6.1.1
  - 预计时间: 1.5 小时

- [ ] **Task 6.2.2**: 内存占用优化
  - 检查内存泄漏
  - 优化渲染进程
  - 验证: 空闲内存 < 200MB
  - 依赖: Task 6.1.1
  - 预计时间: 1.5 小时

### 6.3 发布准备
- [ ] **Task 6.3.1**: 编写用户文档
  - 安装指南
  - 功能说明
  - 常见问题
  - 验证: 文档清晰易懂
  - 依赖: Task 6.2.2
  - 预计时间: 2 小时

- [ ] **Task 6.3.2**: 创建首个 Release
  - 生成版本标签
  - 运行 CI 构建所有平台
  - 发布到 GitHub Releases
  - 验证: 所有平台安装包可用
  - 依赖: Task 6.3.1
  - 预计时间: 1 小时

---

## 并行机会 (Parallelization Opportunities)

以下任务可以并行执行以加速开发：

1. **Task 2.2.2 & Task 3.1.1** - 托盘状态集成和服务器通信层可并行开发
2. **Task 4.1.2 & Task 5.1.1** - 托盘图标准备和 CI 配置可并行
3. **Task 6.1.1, 6.1.2, 6.1.3** - 不同平台测试可并行进行
4. **Task 3.2.2 & Task 3.1.2** - 配置界面和服务器控制 API 可并行

## 关键路径 (Critical Path)

如果时间紧迫，以下是必须按顺序完成的核心路径：

```
Task 1.2.1 → Task 2.1.1 → Task 2.1.2 → Task 2.2.1 → Task 3.1.1 → Task 3.1.2
→ Task 3.3.1 → Task 3.3.2 → Task 4.1.1 → Task 4.2.1 → Task 5.1.1
→ Task 6.1.1 → Task 6.3.2
```

## 风险任务 (Risky Tasks)

以下任务风险较高，需要特别注意：

| 任务 | 风险 | 缓解措施 |
|------|------|----------|
| Task 2.2.1 | Windows 托盘 API 可能有问题 | 优先验证，预留调试时间 |
| Task 3.1.1 | Hagicode Server API 未定义 | 先定义 API 契约或 mock |
| Task 4.2.2 | macOS 构建环境不可用 | 使用 GitHub Actions 验证 |
| Task 5.2.1 | 自动更新配置复杂 | 参考 DML 实现，充分测试 |

## 总时间估算

| Phase | 预计时间 | 可并行 |
|-------|---------|--------|
| Phase 1 | 1.5 小时 | 否 |
| Phase 2 | 4.5 小时 | 部分可并行 |
| Phase 3 | 5 小时 | 部分可并行 |
| Phase 4 | 5 小时 | 部分可并行 |
| Phase 5 | 3 小时 | 部分可并行 |
| Phase 6 | 8 小时 | 部分可并行 |
| **总计** | **27 小时** | **优化后 ~18-20 小时** |

---

## 变更历史

| 日期 | 变更说明 |
|------|----------|
| 2025-02-02 | 初始任务清单 |
