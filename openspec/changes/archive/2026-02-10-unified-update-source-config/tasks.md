# 实施任务清单

**变更 ID:** unified-update-source-config
**关联提案:** proposal.md

## 任务概览

本文档列出了统一应用更新源配置的具体实施任务。任务按依赖关系排序，可以并行执行的任务会特别标注。

---

## 阶段 1: 准备和验证

### 任务 1.1: 验证官方更新服务器配置
- **描述**: 确认 `server.dl.hagicode.com` 的索引文件格式和可用性
- **文件**: 无
- **实施内容**:
  - 访问 `https://server.dl.hagicode.com/index.json` 验证可访问性
  - 检查索引文件格式，确认包含 `channel` 或 `prerelease` 字段
  - 验证不同构建类型的版本是否正确标记
- **验证标准**:
  - 服务器可正常访问
  - 索引文件格式支持构建类型区分
- **估计工作量**: 0.5 小时
- **依赖**: 无
- **可并行**: 是

### 任务 1.2: 添加环境变量支持
- **描述**: 在 `package-source-config-manager.ts` 中添加环境变量覆盖支持
- **文件**: `src/main/package-source-config-manager.ts`
- **实施内容**:
  - 添加 `UPDATE_SOURCE_OVERRIDE` 环境变量检查
  - 解析环境变量中的 JSON 配置
  - 在 `initializeDefaultSource()` 方法中应用覆盖配置
- **验证标准**:
  - 环境变量可以正确覆盖默认源
  - 非法 JSON 格式能够被正确处理
- **估计工作量**: 1 小时
- **依赖**: 无
- **可并行**: 是

### 任务 1.3: 编写单元测试
- **描述**: 为新的环境变量覆盖功能编写单元测试
- **文件**: `src/main/package-source-config-manager.spec.ts` (新建)
- **实施内容**:
  - 测试环境变量正常解析
  - 测试非法 JSON 格式处理
  - 测试默认源配置
- **验证标准**:
  - 所有测试通过
  - 代码覆盖率 > 80%
- **估计工作量**: 1.5 小时
- **依赖**: 任务 1.2
- **可并行**: 否

---

## 阶段 2: 核心实现

### 任务 2.1: 修改默认源配置
- **描述**: 修改 `initializeDefaultSource()` 方法，将默认源统一为 HTTP 索引源
- **文件**: `src/main/package-source-config-manager.ts`
- **实施内容**:
  - 移除开发环境的硬编码本地路径
  - 统一使用 `https://server.dl.hagicode.com/index.json` 作为默认源
  - 添加环境变量覆盖逻辑（已在任务 1.2 中完成）
- **代码变更**:
  ```typescript
  private initializeDefaultSource(): void {
    // 检查环境变量覆盖
    if (process.env.UPDATE_SOURCE_OVERRIDE) {
      try {
        const overrideSource = JSON.parse(process.env.UPDATE_SOURCE_OVERRIDE);
        this.addSource(overrideSource);
        return;
      } catch (error) {
        console.error('Failed to parse UPDATE_SOURCE_OVERRIDE:', error);
      }
    }

    // 统一使用 HTTP 索引源
    const defaultSource: HttpIndexSourceConfig = {
      type: 'http-index',
      name: 'HagiCode 官方源',
      indexUrl: 'https://server.dl.hagicode.com/index.json',
    };

    this.addSource(defaultSource);
  }
  ```
- **验证标准**:
  - 开发和生产环境都使用 HTTP 源
  - 环境变量可以正常覆盖
- **估计工作量**: 1 小时
- **依赖**: 任务 1.2
- **可并行**: 否

### 任务 2.2: 更新类型定义
- **描述**: 确保类型定义支持新的配置结构
- **文件**: `src/main/package-sources/package-source.ts`
- **实施内容**:
  - 检查 `PackageSourceConfig` 类型定义
  - 确保包含 `HttpIndexSourceConfig` 的所有必需字段
  - 添加配置验证接口（如需要）
- **验证标准**:
  - 类型检查通过
  - 没有类型错误
- **估计工作量**: 0.5 小时
- **依赖**: 无
- **可并行**: 是

---

## 阶段 3: 测试和验证

### 任务 3.1: 手动功能测试
- **描述**: 在开发环境中手动测试更新功能
- **文件**: 无
- **实施内容**:
  - 启动应用，检查默认更新源是否为 HTTP 源
  - 测试版本检测功能
  - 测试版本安装功能
  - 验证环境变量覆盖功能
- **验证标准**:
  - 所有功能正常工作
  - 没有控制台错误
- **估计工作量**: 1 小时
- **依赖**: 任务 2.1, 任务 2.2
- **可并行**: 否

### 任务 3.2: 构建版本测试
- **描述**: 构建生产版本并进行测试
- **文件**: 无
- **实施内容**:
  - 执行 `npm run build:local` 构建应用
  - 安装并启动构建版本
  - 验证更新源配置
  - 测试更新功能
- **验证标准**:
  - 构建成功
  - 更新功能正常工作
- **估计工作量**: 1 小时
- **依赖**: 任务 2.1, 任务 2.2
- **可并行**: 是（与任务 3.1）

### 任务 3.3: 集成测试
- **描述**: 运行完整的集成测试套件
- **文件**: 无
- **实施内容**:
  - 运行 `npm test` 执行所有测试
  - 检查测试覆盖率
  - 修复任何发现的问题
- **验证标准**:
  - 所有测试通过
  - 没有回归问题
- **估计工作量**: 0.5 小时
- **依赖**: 任务 2.1, 任务 2.2, 任务 1.3
- **可并行**: 是

---

## 阶段 4: 文档和收尾

### 任务 4.1: 更新开发文档
- **描述**: 更新相关开发文档，说明新的配置方式
- **文件**: `docs/development.md` (新建或更新)
- **实施内容**:
  - 说明默认更新源配置
  - 说明如何使用环境变量覆盖源
  - 添加本地源配置示例
- **验证标准**:
  - 文档清晰易懂
  - 包含必要示例
- **估计工作量**: 0.5 小时
- **依赖**: 任务 2.1
- **可并行**: 是

### 任务 4.2: 更新 README
- **描述**: 在 README 中添加关于更新源配置的说明
- **文件**: `README.md`
- **实施内容**:
  - 添加环境变量说明
  - 链接到详细开发文档
- **验证标准**:
  - 说明简洁明了
- **估计工作量**: 0.25 小时
- **依赖**: 任务 4.1
- **可并行**: 否

### 任务 4.3: 代码审查准备
- **描述**: 整理变更内容，准备代码审查
- **文件**: 无
- **实施内容**:
  - 创建 pull request
  - 添加清晰的描述和测试说明
  - 关联此 OpenSpec 提案
- **验证标准**:
  - PR 描述完整
  - 所有 CI 检查通过
- **估计工作量**: 0.5 小时
- **依赖**: 所有前置任务
- **可并行**: 否

---

## 任务依赖图

```
[1.1] ─────────────────────────────────────┐
                                           │
[1.2] ───> [1.3] ───> [3.3] ──────────────┤
                                           │
[2.1] ───> [2.2] ───> [3.1] ────┐         │
         │                │       │         │
         └────────> [3.2] ────────┘         │
                   │                        │
[4.1] ───> [4.2] ───> [4.3] <──────────────┘
```

---

## 总计工作量估计

| 阶段 | 估计时间 |
|------|---------|
| 阶段 1: 准备和验证 | 3 小时 |
| 阶段 2: 核心实现 | 1.5 小时 |
| 阶段 3: 测试和验证 | 2.5 小时 |
| 阶段 4: 文档和收尾 | 1.25 小时 |
| **总计** | **8.25 小时** |

---

## 风险和注意事项

1. **网络依赖**: 测试阶段需要稳定的网络连接访问官方更新服务器
2. **环境变量**: 确保团队成员了解新的环境变量配置方式
3. **本地开发**: 提供清晰的本地开发配置指南，避免影响开发效率
4. **回滚准备**: 如遇问题，可快速回滚到原来的多源配置
